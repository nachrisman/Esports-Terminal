{"filter":false,"title":"meta.js","tooltip":"/legacy/meta.js","undoManager":{"mark":0,"position":0,"stack":[[{"start":{"row":0,"column":0},"end":{"row":82,"column":3},"action":"insert","lines":["router.get(\"/meta\", middleware.isLoggedIn, function(req, res){","\tvar meta = req.user.meta,","\t\tgames = [];","\t","\tmeta.forEach(function(metaOption){","\t\tif(metaOption.news == true){ games.push(metaOption.game); }\t","\t});","\t","\tArticle.find({categories: {$in: games}}).sort({published: -1}).limit(games.length * 10).exec(function(err, articles){","\t\tif(err){","\t\t\tconsole.log(\"Article Query Error: \" + err.message);","\t\t\treq.flash(\"error\", \"There was an error loading your account page. Please try again.\");","\t\t\treturn res.redirect(\"/news\");","\t\t} else {","\t\t\tres.render(\"meta\", {games: games, articles: articles});","\t\t}","\t});","});","","router.get(\"/meta-settings\", middleware.isLoggedIn, function(req, res){","\tGame.find({}, function(err, games){","\t\tif(err){","\t\t\tconsole.log(\"Game Query Error: \" + err.message);","\t\t\treq.flash(\"error\", \"There was an error loading the page. Please try again.\")","\t\t\treturn res.redirect(\"/news\");","\t\t} else {","\t\t\tres.render(\"account_meta_settings\", {games: games});","\t\t}","\t});","});","","router.put(\"/meta-settings\", middleware.isLoggedIn, function(req, res){","\tvar userMeta = req.user.meta,","\t\tupdatedEvents = req.body.events,","\t\tupdatedNews = req.body.news,","\t    updatedMeta = [];","\t","\tuserMeta.forEach(function(meta){","\t\tif(updatedEvents.indexOf(meta.game) > -1){","\t\t\tmeta.events = true;","\t\t\tupdatedEvents.splice(updatedEvents.indexOf(meta.game), 1);","\t\t} else {","\t\t\tmeta.events = false;","\t\t}","","\t\tif(updatedNews.indexOf(meta.game) > -1){","\t\t\tmeta.news = true;","\t\t\tupdatedNews.splice(updatedNews.indexOf(meta.game), 1);","\t\t} else {","\t\t\tmeta.news = false;","\t\t}","\t});","\t","\tif(updatedEvents.length > 0){","\t\tupdatedEvents.forEach(function(event){","\t\t\tupdatedMeta.push({game: event, events: true, news: false});\t","\t\t});","\t}","\t","\tif(updatedNews.length > 0){","\t\tupdatedNews.forEach(function(news){","\t\t\tif(updatedMeta.find(meta => meta.game == news)) {","\t\t\t\tupdatedMeta.find(meta => meta.game == news).news = true;","\t\t\t} else {","\t\t\t\tupdatedMeta.push({game: news, events: false, news: true});","\t\t\t}\t","\t\t});","\t}","\t","\tuserMeta.forEach(function(meta){","\t\tupdatedMeta.push(meta);\t","\t});","\t","\tUser.findByIdAndUpdate(req.user._id, {$set: {meta: updatedMeta } }, function(err, updatedUser){","\t\tif(err){","\t\t\treq.flash('error', err.message);","\t\t\treturn res.redirect('/account/meta-settings');","\t\t} else {","\t\t\treq.flash('success', 'Your META has been updated. Enjoy the new content!');","\t\t\tres.redirect('/account/meta-settings');","\t\t}","\t});","});"],"id":1}]]},"ace":{"folds":[],"scrolltop":1144,"scrollleft":0,"selection":{"start":{"row":60,"column":4},"end":{"row":60,"column":4},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":53,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1515803261609,"hash":"2e88ff04bacf531d38940231f71d1d2fe9c2637d"}